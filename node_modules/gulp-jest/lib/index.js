'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _jestCli = require('jest-cli');

var _jestCli2 = _interopRequireDefault(_jestCli);

var _pluginError = require('plugin-error');

var _pluginError2 = _interopRequireDefault(_pluginError);

var _through = require('through2');

var _through2 = _interopRequireDefault(_through);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = function () {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  return _through2.default.obj(function (file, enc, cb) {
    options = Object.assign({
      rootDir: file ? process.cwd() : undefined
    }, options);

    _jestCli2.default.runCLI(options, [options.rootDir]).then(function (_ref) {
      var results = _ref.results;

      if (results.numFailedTests || results.numFailedTestSuites) {
        cb(new _pluginError2.default('gulp-jest', { message: 'Tests Failed' }));
      } else if (typeof results.success !== 'undefined' && !results.success) {
        cb(new _pluginError2.default('gulp-jest', { message: 'Tests Failed due to coverage threshold breaches' }));
      } else {
        cb();
      }
    });
  });
};